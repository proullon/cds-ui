/*! swimming-poll - 2.6.0 - 2015-07-03 */
angular.module("swimmingPoll",[]),angular.module("swimmingPoll").service("Poller",["$q","$timeout","$http",function(a,b,c){"use strict";function d(a,b){a.retryCountAttempts=0,a.deferredObj.resolve(b),_.remove(m,a)}function e(a,c){a.retryCountAttempts<a.retryMaxAttempts?(a.retryCountAttempts++,b(function(){i(a)},a.retryTimeoutDelay)):(a.deferredObj.reject(c),_.remove(m,a))}function f(a,b){a.retryCountAttempts=0,a.deferredObj.notify(b),a.lastResult=angular.copy(b),g(a)}function g(a){a.timeoutPromise=b(function(){i(a)},a.interval)}function h(a,b){return"function"==typeof a?a(b):_.every(a,function(a,c){return"function"==typeof a?a(b):b[c]===a})}function i(a){c.get(a.url,a.opts).then(function(b){b=b.data;var c=[];angular.isArray(b)?c=b:c.push(b);var g=0,i=0,j=0;return angular.forEach(c,function(c){if(a.successRule)h(a.successRule,c)?g++:a.errorRule&&h(a.errorRule,c)?i++:j++;else switch(b.status){case"done":case"cancelled":case"DONE":case"CANCELLED":g++;break;case"customerError":case"ovhError":case"error":case"blocked":case"CUSTOMER_ERROR":case"OVH_ERROR":case"ERROR":case"BLOCKED":i++;break;default:a.errorRule&&h(a.errorRule,c)?i++:j++}}),g===c.length?d(a,b):!i||j||a.notifyOnError?f(a,b):e(a,b)},function(b){return 404===b.status&&a.lastResult?d(a,a.lastResult):0!==b.status?e(a,b):void 0})}var j=7e3,k=3,l=1e4,m=[];this.poll=function(b,c,d){c||(c={}),d||(d={});var e=_.find(m,{url:b,scope:d.scope||null,namespace:d.namespace||null});if(e)return e.deferredObj.promise;var f=a.defer(),g=angular.extend({deferredObj:a.defer(),timeoutDeferredObj:f,url:b,opts:angular.extend(c,{timeout:f.promise}),interval:j,lastResult:null,successRule:null,errorRule:null,scope:null,namespace:null,retryMaxAttempts:k,retryCountAttempts:0,retryTimeoutDelay:l},d);return m.push(g),i(g),g.deferredObj.promise},this.kill=function(a){var c=_.filter(m,a);c.length&&(angular.forEach(c,function(a){a.timeoutDeferredObj.resolve(),a.deferredObj.reject({}),b.cancel(a.timeoutPromise)}),_.remove(m,a))}}]);